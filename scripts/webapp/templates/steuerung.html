{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename= 'css/steuerung.css') }}">

<h1>{% block title %} Steuerung {% endblock %}</h1>

<div class="bigContainer">
	
	<div class="buttonTextContainer">
		<div class="buttonContainer">
			<button class="btn btn-primary" id="startButton" onclick="this.blur()">Start Robot</button> <!--; submitForm()-->
			<button class="btn btn-danger" id="stopButton" onclick="this.blur();">Stop Robot</button>
		</div>
		<p>Robot Data: <span id="robotData">No data yet</span></p>
    </div>
	
	<div class="container">
		<form method="POST">
			<label for="countdown">Start des Countdown:</label>
			<input type="text" id="countdown" name="countdown"><br><br>
			<label for="lrate">Learning Rate:</label>
			<input type="text" id="lrate" name="lrate"><br><br>
			<label for="dfactor">discount_factor:</label>
			<input type="text" id="dfactor" name="dfactor"><br><br>
		</form>
	</div>

</div>


  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    document.getElementById('startButton').addEventListener('click', function() {
		var countdownValue = document.getElementById('countdown').value;
		var lrateValue = document.getElementById('lrate').value;/*, 'learningRate=' + encodeURIComponent(lrateValue)*/
		var dfactorValue = document.getElementById('dfactor').value;
      fetch('/start', { method: 'POST',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded'
			},
			body: 'countdown=' + encodeURIComponent(countdownValue)+
			'&lrate=' + encodeURIComponent(lrateValue)+
			'&dfactor=' + encodeURIComponent(dfactorValue)
			 })
        .then(response => response.json())
        .then(data => {
          console.log(data);
          fetchData();
        });
    });
  
    document.getElementById('stopButton').addEventListener('click', function() {
      fetch('/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          console.log('Success:',data);
          fetchData();
        });
    });
  
    function fetchData() {
      fetch('/data')
        .then(response => response.json())
        .then(data => {
          document.getElementById('robotData').textContent = data.data;
        });
    }
    
    function submitForm() { <!-- Isn't being used anymore, function is instead called via eventListener above
		var countdownValue = document.getElementById('countdown').value;
		var lrateValue = document.getElementById('lrate').value;
		var dfactorValue = document.getElementById('dfactor').value;


		fetch('http://localhost:5000/start', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded'
			},
			body: 'countdown=' + encodeURIComponent(countdownValue)+
			'&lrate=' + encodeURIComponent(lrateValue)+
			'&dfactor=' + encodeURIComponent(dfactorValue)
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			fetchData();
		})
		.catch((error) => {
			console.error('Error:', error);
		});
	}

        // Connect to the WebSocket server
        var ws = new WebSocket("ws://localhost:5000/ws");

        ws.onmessage = function(event) {
            fetchData();
        };
        
    // Function to save form data to localStorage
        function saveFormData() {
            const countdown = document.getElementById('countdown').value;
            const lrate = document.getElementById('lrate').value;
            const dfactor = document.getElementById('dfactor').value;
            localStorage.setItem('countdown', countdown);
            localStorage.setItem('lrate', lrate);
            localStorage.setItem('dfactor', dfactor);
        }

        // Function to load form data from localStorage
        function loadFormData() {
            document.getElementById('countdown').value = localStorage.getItem('countdown') || '';
            document.getElementById('lrate').value = localStorage.getItem('lrate') || '';
            document.getElementById('dfactor').value = localStorage.getItem('dfactor') || '';
            fetchData()
        }
        
        // Save data when input fields change
        document.getElementById('countdown').addEventListener('input', saveFormData);
        document.getElementById('lrate').addEventListener('input', saveFormData);
        document.getElementById('dfactor').addEventListener('input', saveFormData);


        // Load saved data on page load
        window.onload = loadFormData;
    
  </script>

{% endblock %}
